# 計画書 05: スマートクロッピングとデバッグ表示機能

## 概要
ユーザーがカメラから離れた際に顔認識（とスマイル判定）が外れてしまう問題に対処し、さらに開発・実演時の利便性を向上させるための改修を行いました。

## 課題
1. **遠距離での認識精度**: 全身を映すために離れると、顔の解像度が低下し、顔認識（Face Landmarker）が機能しなくなる。
2. **画面の視認性**: 骨格やメッシュのデバッグ線が常に表示されていると、本来のUIが見づらい場合がある。

## 実装内容

### 1. スマートクロッピング (Smart Cropping)
Pose Detection（姿勢検知）の堅牢性を利用し、Face Detectionを補助する仕組みを導入しました。

- **ロジック**:
    1. まず `PoseLandmarker` で全身の姿勢を検出。
    2. 検出された姿勢から「頭部」の位置（鼻、目、耳の座標）を特定。
    3. その座標をもとに、頭部周辺の画像をデジタル的に切り出し（ROI: Region of Interest）。
    4. 切り出した高解像度の画像を `FaceLandmarker` に入力。
    5. これにより、カメラから3〜4メートル離れていても、AIの視点では「顔のアップ」として処理され、高精度なスマイル判定が可能になりました。

### 2. デバッグ表示トグル (Debug Toggle)
画面上の識別線（ワイヤーフレーム）の表示/非表示を切り替える機能を追加しました。

- **機能**:
    - 画面右上に `Debug View: ON/OFF` ボタンを配置。
    - **ON**: 骨格（赤線）、顔メッシュ（白線）、ROI枠（水色）を表示。
    - **OFF**: 上記の線をすべて非表示にし、映像のみを表示。
    - **特記事項**: 表示がOFFでも、内部のAI検出とスコア計算は継続しているため、カウントや「SMILING!」演出は機能します。

### 3. メッシュ座標の補正
スマートクロッピング導入に伴い、切り抜いた画像の座標系で検出された顔メッシュを、元のカメラ映像の座標系に逆変換（マッピング）して描画する処理を追加しました。これにより、ズーム認識中も正しい位置にメッシュが表示されます。

## 結果
遠距離からのスクワット動作を行いながら、正確に笑顔を検知できるようになりました。また、必要に応じて画面をすっきりさせることが可能になりました。
