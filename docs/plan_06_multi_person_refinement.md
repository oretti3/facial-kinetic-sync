# Plan 06: Multi-Person Refinement & UX Polish

## 概要 (Overview)
複数人同時トラッキングの安定化、ID管理の堅牢化、およびユーザーインターフェース（UI）の大幅な改善を行いました。
特に「画面から人が消えた際の挙動」と「再出現時のIDリカバリ」に重点を置き、自然でストレスのない体験を実現しました。

## 実装機能 ( implemented Features)

### 1. 堅牢なIDトラッキング (Robust ID Tracking)
- **重心マッチング**: フレーム間の移動距離に基づいて、人が動いてもID（1, 2, 3...）が追従するロジックを実装。
- **高速IDリサイクル**: 画面から消えたユーザーのIDを約0.3秒（10フレーム）保持した後、即座に解放。
  - これにより、人が頻繁に入れ替わる環境でも、IDが無駄に増え続ける（ID: 100などになる）ことを防ぎます。
- **Visibility状態**: 内部的に `Visible`（画面内）と `Wait`（消失中・タイムアウト待ち）の状態を管理し、ユーザーには明確に区別して表示。

### 2. 並列スマートクロッピング (Parallel Smart Cropping)
- **全ユーザー高解像度解析**: 画面内の全員（最大設定数まで）に対して個別に顔領域（ROI）を切り出し、ズームして解析。
- **MediaPipe Image Mode**: 複数クロップ処理時のタイムスタンプ競合を防ぐため、FaceLandmarkerを `IMAGE` モードで運用。遠く離れた人の笑顔も高精度に検知可能。

### 3. UI/UXの刷新 (UI/UX Overhaul)
- **おでこタブ表示**: スクワット回数やIDを表示する情報ボックスを、鼻の位置から「おでこ付近」に移動し、顔が隠れないように配慮。
- **ダイナミック背景**:
  - 通常時: 半透明ブラック
  - **笑顔時**: 半透明ピンク + "😊 Good!" 表示
  - 視覚的なフィードバックを強化。
- **表示モード切替**:
  - **Debug OFF**: カウントとスマイル判定のみのシンプル表示。
  - **Debug ON**: 骨格、ROI枠、関節角度、詳細スコアを表示。
- **Max People設定**: 検出人数を1〜5人の間でリアルタイムに変更可能なUIを追加。

## 技術的詳細 (Technical Details)
- **ID割り当て**: `Set<number>` を使用してフレームごとの使用済みIDを管理し、空いている最小のIDを常に再利用するアルゴリズムを採用。
- **MediaPipe最適化**: `PoseLandmarker`（全身検出）は常にGPU/Videoモードで動作させつつ、顔解析は静止画モードで随時実行するハイブリッド構成。

## 次のステップ (Next Steps)
- ゲーム化要素（ランキング、対戦モードなど）の検討
- スマイル検知のしきい値調整や個人差への対応
